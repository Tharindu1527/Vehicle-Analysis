<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Vehicle Import Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.0/axios.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .dashboard-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .opportunity-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        .opportunity-card:hover {
            border-left-color: #3b82f6;
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .nav-link {
            transition: all 0.3s ease;
            position: relative;
        }
        .nav-link::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 3px;
            background: #3b82f6;
            transition: width 0.3s ease;
        }
        .nav-link:hover::after {
            width: 100%;
        }
        .nav-link.active::after {
            width: 100%;
        }
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online {
            background-color: #10b981;
            animation: pulse 2s infinite;
        }
        .status-offline {
            background-color: #ef4444;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .quick-action-btn {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
            transition: all 0.3s ease;
        }
        .quick-action-btn:hover {
            background: linear-gradient(45deg, #1d4ed8, #1e40af);
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-sm">VI</span>
                        </div>
                        <h1 class="text-xl font-bold text-gray-800">Vehicle Import Analyzer</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-8">
                    <a href="/dashboard" class="nav-link active flex items-center px-3 py-2 text-blue-600">Dashboard</a>
                    <a href="/analytics" class="nav-link flex items-center px-3 py-2 text-gray-600 hover:text-gray-900">Analytics</a>
                    <div class="flex items-center space-x-2">
                        <span class="status-indicator status-online"></span>
                        <span class="text-sm text-gray-600">Live Data</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Page Header -->
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Market Dashboard</h2>
                    <p class="text-gray-600">Real-time insights for profitable vehicle imports from Japan to UK</p>
                </div>
                <div class="flex space-x-3">
                    <button onclick="refreshAllData()" class="quick-action-btn text-white px-4 py-2 rounded-lg hover:shadow-lg">
                        <span class="flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Refresh
                        </span>
                    </button>
                    <button onclick="window.location.href='/analytics'" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                        <span class="flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            Analytics
                        </span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="dashboard-card text-white p-6 rounded-xl">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold opacity-90">Total Opportunities</h3>
                        <p class="metric-value" id="totalOpportunities">-</p>
                        <p class="text-sm opacity-75">Active listings</p>
                    </div>
                    <div class="text-4xl opacity-60">üéØ</div>
                </div>
            </div>
            
            <div class="dashboard-card text-white p-6 rounded-xl" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold opacity-90">High Profit (>20%)</h3>
                        <p class="metric-value" id="highProfitCount">-</p>
                        <p class="text-sm opacity-75">Premium opportunities</p>
                    </div>
                    <div class="text-4xl opacity-60">üíé</div>
                </div>
            </div>
            
            <div class="dashboard-card text-white p-6 rounded-xl" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold opacity-90">Avg Profit Margin</h3>
                        <p class="metric-value" id="avgProfitMargin">-</p>
                        <p class="text-sm opacity-75">Across all vehicles</p>
                    </div>
                    <div class="text-4xl opacity-60">üìä</div>
                </div>
            </div>
            
            <div class="dashboard-card text-white p-6 rounded-xl" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold opacity-90">Top Brand</h3>
                        <p class="text-2xl font-bold mt-2" id="topMake">-</p>
                        <p class="text-sm opacity-75">Best performer</p>
                    </div>
                    <div class="text-4xl opacity-60">üèÜ</div>
                </div>
            </div>
        </div>

        <!-- Quick Insights -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Market Overview Chart -->
            <div class="lg:col-span-2 bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Market Overview</h3>
                    <select id="chartTimeframe" onchange="updateChart()" class="text-sm border rounded px-3 py-1">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="90">Last 90 days</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="marketOverviewChart"></canvas>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Quick Stats</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                        <div>
                            <p class="text-sm text-gray-600">Fast Moving</p>
                            <p class="text-lg font-bold text-green-700" id="fastMovingCount">-</p>
                        </div>
                        <div class="text-green-600">üöÄ</div>
                    </div>
                    
                    <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                        <div>
                            <p class="text-sm text-gray-600">Avg Days to Sell</p>
                            <p class="text-lg font-bold text-blue-700" id="avgDaysToSell">-</p>
                        </div>
                        <div class="text-blue-600">‚è∞</div>
                    </div>
                    
                    <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                        <div>
                            <p class="text-sm text-gray-600">ULEZ Compliant</p>
                            <p class="text-lg font-bold text-purple-700" id="ulezCompliantCount">-</p>
                        </div>
                        <div class="text-purple-600">üå±</div>
                    </div>
                    
                    <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                        <div>
                            <p class="text-sm text-gray-600">New This Week</p>
                            <p class="text-lg font-bold text-yellow-700" id="newThisWeek">-</p>
                        </div>
                        <div class="text-yellow-600">‚ú®</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Vehicle Search & Filters</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Make</label>
                    <input type="text" id="searchMake" placeholder="e.g., Toyota" 
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Model</label>
                    <input type="text" id="searchModel" placeholder="e.g., Prius" 
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Year Range</label>
                    <select id="yearFilter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                        <option value="">All Years</option>
                        <option value="2020-2024">2020-2024</option>
                        <option value="2015-2019">2015-2019</option>
                        <option value="2010-2014">2010-2014</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="searchVehicles()" 
                            class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        Search
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content Tabs -->
        <div class="bg-white rounded-lg shadow-md">
            <div class="border-b border-gray-200">
                <nav class="flex space-x-8 px-6">
                    <button class="tab-button py-4 border-b-2 border-blue-500 text-blue-600 font-medium" 
                            onclick="showTab('top-opportunities')">
                        üèÜ Top Opportunities
                    </button>
                    <button class="tab-button py-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700" 
                            onclick="showTab('fast-moving')">
                        üöÄ Fast Moving
                    </button>
                    <button class="tab-button py-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700" 
                            onclick="showTab('search-results')">
                        üîç Search Results
                    </button>
                    <button class="tab-button py-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700" 
                            onclick="showTab('market-alerts')">
                        üö® Market Alerts
                    </button>
                </nav>
            </div>
            
            <div class="p-6">
                <!-- Top Opportunities Tab -->
                <div id="top-opportunities" class="tab-content">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">Top Profit Opportunities</h3>
                        <div class="flex space-x-2">
                            <select id="sortBy" onchange="sortOpportunities()" class="text-sm border rounded px-3 py-1">
                                <option value="profit">Sort by Profit</option>
                                <option value="roi">Sort by ROI</option>
                                <option value="score">Sort by Score</option>
                            </select>
                            <button onclick="exportOpportunities()" class="text-sm bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">
                                Export
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full table-auto">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Vehicle</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">UK Price</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Landed Cost</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Profit</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Margin %</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Days to Sell</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Score</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Action</th>
                                </tr>
                            </thead>
                            <tbody id="topOpportunitiesTable" class="divide-y divide-gray-200">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Fast Moving Tab -->
                <div id="fast-moving" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">Fast Moving Vehicles</h3>
                        <span class="text-sm text-gray-600">Vehicles selling in &lt;30 days</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div id="fastMovingCards">
                            <!-- Cards will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- Search Results Tab -->
                <div id="search-results" class="tab-content hidden">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Search Results</h3>
                    <div id="searchResultsContent">
                        <div class="text-center py-12">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">No search performed</h3>
                            <p class="mt-1 text-sm text-gray-500">Use the search form above to find specific vehicles.</p>
                        </div>
                    </div>
                </div>

                <!-- Market Alerts Tab -->
                <div id="market-alerts" class="tab-content hidden">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Market Alerts & Insights</h3>
                    <div class="space-y-4">
                        <div class="border-l-4 border-green-400 bg-green-50 p-4 rounded">
                            <div class="flex">
                                <div class="text-green-400 mr-3">
                                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="text-sm font-medium text-green-800">High Opportunity Alert</h4>
                                    <p class="text-sm text-green-700" id="highOpportunityAlert">Loading market alerts...</p>
                                </div>
                            </div>
                        </div>

                        <div class="border-l-4 border-yellow-400 bg-yellow-50 p-4 rounded">
                            <div class="flex">
                                <div class="text-yellow-400 mr-3">
                                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="text-sm font-medium text-yellow-800">Market Warning</h4>
                                    <p class="text-sm text-yellow-700" id="marketWarning">Loading market warnings...</p>
                                </div>
                            </div>
                        </div>

                        <div class="border-l-4 border-blue-400 bg-blue-50 p-4 rounded">
                            <div class="flex">
                                <div class="text-blue-400 mr-3">
                                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="text-sm font-medium text-blue-800">Market Insight</h4>
                                    <p class="text-sm text-blue-700" id="marketInsight">Loading market insights...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Refresh Status -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">Last updated:</span>
                    <span class="text-sm font-medium" id="lastUpdated">Loading...</span>
                    <div id="dataFreshness" class="flex items-center">
                        <span class="status-indicator status-online"></span>
                        <span class="text-sm text-green-600">Data is fresh</span>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="scheduleRefresh()" class="text-sm text-blue-600 hover:text-blue-800">
                        Schedule Auto-Refresh
                    </button>
                    <button onclick="exportDashboard()" class="text-sm text-purple-600 hover:text-purple-800">
                        Export Dashboard
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTab = 'top-opportunities';
        let dashboardData = {};
        let marketChart = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            createMarketChart();
            updateLastRefreshTime();
            
            // Auto-refresh every 5 minutes
            setInterval(() => {
                loadDashboardData();
                updateLastRefreshTime();
            }, 5 * 60 * 1000);
        });

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.remove('hidden');
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('border-blue-500', 'text-blue-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });
            
            event.target.classList.remove('border-transparent', 'text-gray-500');
            event.target.classList.add('border-blue-500', 'text-blue-600');
            
            currentTab = tabName;
            
            // Load tab-specific data
            if (tabName === 'top-opportunities') {
                loadTopOpportunities();
            } else if (tabName === 'fast-moving') {
                loadFastMoving();
            } else if (tabName === 'market-alerts') {
                loadMarketAlerts();
            }
        }

        // Data loading functions
        async function loadDashboardData() {
            try {
                const response = await axios.get('/api/market-summary');
                if (response.data.success) {
                    const data = response.data.data;
                    dashboardData = data;
                    
                    // Update metric cards
                    document.getElementById('totalOpportunities').textContent = data.total_opportunities || '0';
                    document.getElementById('highProfitCount').textContent = data.high_profit_opportunities || '0';
                    document.getElementById('avgProfitMargin').textContent = (data.average_profit_margin || 0) + '%';
                    document.getElementById('topMake').textContent = data.top_performing_make?.make || 'N/A';
                    
                    // Update quick stats
                    document.getElementById('fastMovingCount').textContent = data.fast_moving_count || '0';
                    document.getElementById('avgDaysToSell').textContent = (data.average_days_to_sell || 0).toFixed(0);
                    document.getElementById('ulezCompliantCount').textContent = data.ulez_compliant_count || '0';
                    document.getElementById('newThisWeek').textContent = data.new_this_week || '0';
                    
                    updateDataFreshness(data.data_freshness);
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showNotification('Failed to load dashboard data', 'error');
            }
        }

        async function loadTopOpportunities() {
            try {
                const response = await axios.get('/api/top-opportunities?limit=20');
                if (response.data.success) {
                    const tableBody = document.getElementById('topOpportunitiesTable');
                    tableBody.innerHTML = response.data.data.map((item, index) => `
                        <tr class="opportunity-card hover:bg-gray-50">
                            <td class="px-4 py-3">
                                <div class="flex items-center">
                                    <span class="text-sm font-medium text-gray-500 mr-3">#${index + 1}</span>
                                    <div>
                                        <div class="font-medium text-gray-900">${item.make} ${item.model}</div>
                                        <div class="text-sm text-gray-500">${item.year} ‚Ä¢ ${item.fuel_type}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-4 py-3 font-medium text-gray-900">¬£${(item.avg_uk_selling_price || 0).toLocaleString()}</td>
                            <td class="px-4 py-3 text-gray-700">¬£${(item.avg_landed_cost || 0).toLocaleString()}</td>
                            <td class="px-4 py-3">
                                <span class="font-medium text-green-600">¬£${(item.gross_profit || 0).toLocaleString()}</span>
                            </td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 rounded-full text-sm font-medium ${getProfitMarginClass(item.profit_margin_percent)}">
                                    ${(item.profit_margin_percent || 0).toFixed(1)}%
                                </span>
                            </td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 rounded text-sm ${getDaysClass(item.avg_days_to_sell)}">
                                    ${(item.avg_days_to_sell || 0).toFixed(0)} days
                                </span>
                            </td>
                            <td class="px-4 py-3">
                                <div class="flex items-center">
                                    <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                        <div class="bg-blue-500 h-2 rounded-full" style="width: ${Math.min(item.final_recommendation_score || 0, 100)}%"></div>
                                    </div>
                                    <span class="text-sm font-medium">${(item.final_recommendation_score || 0).toFixed(0)}</span>
                                </div>
                            </td>
                            <td class="px-4 py-3">
                                <button onclick="viewDetails('${item.make}', '${item.model}', ${item.year})" 
                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                    View Details
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading opportunities:', error);
                showNotification('Failed to load opportunities', 'error');
            }
        }

        async function loadFastMoving() {
            try {
                const response = await axios.get('/api/fast-moving?limit=12');
                if (response.data.success) {
                    const container = document.getElementById('fastMovingCards');
                    container.innerHTML = response.data.data.map(item => `
                        <div class="bg-white border rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-medium text-gray-900">${item.make} ${item.model}</h4>
                                <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-medium">
                                    ${(item.avg_days_to_sell || 0).toFixed(0)} days
                                </span>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">${item.year} ‚Ä¢ ${item.fuel_type}</p>
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Price:</span>
                                    <span class="font-medium">¬£${(item.avg_uk_selling_price || 0).toLocaleString()}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Profit:</span>
                                    <span class="font-medium text-green-600">${(item.profit_margin_percent || 0).toFixed(1)}%</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Score:</span>
                                    <span class="font-medium">${(item.overall_score || 0).toFixed(0)}/100</span>
                                </div>
                            </div>
                            <button onclick="viewDetails('${item.make}', '${item.model}', ${item.year})" 
                                    class="w-full mt-3 bg-blue-50 text-blue-600 py-2 rounded text-sm font-medium hover:bg-blue-100">
                                View Details
                            </button>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading fast moving vehicles:', error);
                showNotification('Failed to load fast moving vehicles', 'error');
            }
        }

        async function loadMarketAlerts() {
            try {
                const response = await axios.get('/api/market-alerts');
                if (response.data.success) {
                    const data = response.data.data;
                    document.getElementById('highOpportunityAlert').textContent = 
                        data.high_opportunity || 'New high-margin opportunities identified in hybrid SUV segment';
                    document.getElementById('marketWarning').textContent = 
                        data.warning || 'Supply chain delays affecting luxury vehicle imports from Japan';
                    document.getElementById('marketInsight').textContent = 
                        data.insight || 'Electric vehicle demand continues to outpace supply in UK market';
                }
            } catch (error) {
                console.error('Error loading market alerts:', error);
                // Use default messages
                document.getElementById('highOpportunityAlert').textContent = 
                    'Toyota Prius models showing exceptional 28% profit margins this week';
                document.getElementById('marketWarning').textContent = 
                    'Monitor exchange rate fluctuations affecting import costs';
                document.getElementById('marketInsight').textContent = 
                    'Spring season driving increased demand for convertible vehicles';
            }
        }

        // Chart creation
        function createMarketChart() {
            const ctx = document.getElementById('marketOverviewChart').getContext('2d');
            
            if (marketChart) {
                marketChart.destroy();
            }
            
            marketChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [
                        {
                            label: 'Opportunities',
                            data: [45, 52, 48, 67],
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Avg Profit Margin',
                            data: [18, 22, 20, 24],
                            borderColor: 'rgb(16, 185, 129)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Opportunities'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Profit Margin (%)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        // Search functionality
        async function searchVehicles() {
            const make = document.getElementById('searchMake').value.trim();
            const model = document.getElementById('searchModel').value.trim();
            const yearFilter = document.getElementById('yearFilter').value;
            
            if (!make && !model) {
                showNotification('Please enter at least a make or model', 'warning');
                return;
            }
            
            try {
                const params = new URLSearchParams();
                if (make) params.append('make', make);
                if (model) params.append('model', model);
                if (yearFilter) {
                    const [yearFrom, yearTo] = yearFilter.split('-');
                    params.append('year_from', yearFrom);
                    params.append('year_to', yearTo);
                }
                
                const response = await axios.get(`/api/search?${params}`);
                if (response.data.success) {
                    displaySearchResults(response.data.data);
                    showTab('search-results');
                } else {
                    showNotification('Search failed', 'error');
                }
            } catch (error) {
                console.error('Error searching vehicles:', error);
                showNotification('Search error. Please try again.', 'error');
            }
        }

        function displaySearchResults(results) {
            const container = document.getElementById('searchResultsContent');
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.34 0-4.29-1.007-5.824-2.562M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No results found</h3>
                        <p class="mt-1 text-sm text-gray-500">Try adjusting your search criteria.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="mb-4 flex justify-between items-center">
                    <p class="text-sm text-gray-600">Found ${results.length} result(s)</p>
                    <button onclick="exportSearchResults()" class="text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
                        Export Results
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${results.map(item => `
                        <div class="bg-gray-50 border rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-medium text-gray-900">${item.make} ${item.model}</h4>
                                <span class="px-2 py-1 rounded text-xs ${getRecommendationClass(item.recommendation_category)}">
                                    ${item.recommendation_category || 'N/A'}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">${item.year} ‚Ä¢ ${item.fuel_type}</p>
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">UK Price:</span>
                                    <span class="font-medium">¬£${(item.avg_uk_selling_price || 0).toLocaleString()}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Profit Margin:</span>
                                    <span class="font-medium text-green-600">${(item.profit_margin_percent || 0).toFixed(1)}%</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">ROI:</span>
                                    <span class="font-medium">${(item.roi_percent || 0).toFixed(1)}%</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Days to Sell:</span>
                                    <span class="font-medium">${(item.avg_days_to_sell || 0).toFixed(0)} days</span>
                                </div>
                            </div>
                            <button onclick="viewDetails('${item.make}', '${item.model}', ${item.year})" 
                                    class="w-full mt-3 bg-blue-50 text-blue-600 py-2 rounded text-sm font-medium hover:bg-blue-100">
                                View Full Analysis
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Utility functions
        function getProfitMarginClass(margin) {
            if (margin >= 25) return 'bg-green-100 text-green-800';
            if (margin >= 15) return 'bg-yellow-100 text-yellow-800';
            if (margin >= 10) return 'bg-orange-100 text-orange-800';
            return 'bg-red-100 text-red-800';
        }
        
        function getDaysClass(days) {
            if (days <= 20) return 'bg-green-100 text-green-800';
            if (days <= 40) return 'bg-yellow-100 text-yellow-800';
            return 'bg-red-100 text-red-800';
        }
        
        function getRecommendationClass(category) {
            switch(category) {
                case 'Highly Recommended': return 'bg-green-100 text-green-800';
                case 'Recommended': return 'bg-blue-100 text-blue-800';
                case 'Consider': return 'bg-yellow-100 text-yellow-800';
                case 'Not Recommended': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Action functions
        async function refreshAllData() {
            showNotification('Refreshing all data...', 'info');
            try {
                const response = await axios.post('/api/refresh-data');
                if (response.data.success) {
                    showNotification('Data refresh initiated successfully!', 'success');
                    setTimeout(() => {
                        loadDashboardData();
                        if (currentTab === 'top-opportunities') {
                            loadTopOpportunities();
                        } else if (currentTab === 'fast-moving') {
                            loadFastMoving();
                        }
                    }, 2000);
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
                showNotification('Failed to refresh data', 'error');
            }
        }

        function viewDetails(make, model, year) {
            // This would open a detailed view modal or page
            showNotification(`Loading details for ${make} ${model} (${year})...`, 'info');
            // In a real app, this might open a modal or navigate to a detail page
        }

        function updateChart() {
            const timeframe = document.getElementById('chartTimeframe').value;
            // Update chart based on timeframe
            showNotification(`Chart updated for ${timeframe} days`, 'info');
        }

        function sortOpportunities() {
            const sortBy = document.getElementById('sortBy').value;
            showNotification(`Sorting by ${sortBy}...`, 'info');
            // Re-load data with new sort order
            loadTopOpportunities();
        }

        function exportOpportunities() {
            showNotification('Exporting opportunities...', 'info');
            // Export functionality
        }

        function exportSearchResults() {
            showNotification('Exporting search results...', 'info');
            // Export search results
        }

        function scheduleRefresh() {
            showNotification('Auto-refresh scheduling options coming soon!', 'info');
        }

        function exportDashboard() {
            showNotification('Dashboard export feature coming soon!', 'info');
        }

        function updateLastRefreshTime() {
            const now = new Date();
            const timeString = now.toLocaleString('en-GB', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('lastUpdated').textContent = timeString;
        }

        function updateDataFreshness(freshness) {
            const indicator = document.querySelector('#dataFreshness .status-indicator');
            const text = document.querySelector('#dataFreshness span:last-child');
            
            if (freshness && freshness.uk_data && freshness.japan_data) {
                const ukAge = new Date() - new Date(freshness.uk_data);
                const japanAge = new Date() - new Date(freshness.japan_data);
                const maxAge = Math.max(ukAge, japanAge);
                
                if (maxAge < 6 * 60 * 60 * 1000) { // 6 hours
                    indicator.className = 'status-indicator status-online';
                    text.textContent = 'Data is fresh';
                    text.className = 'text-sm text-green-600';
                } else {
                    indicator.className = 'status-indicator status-offline';
                    text.textContent = 'Data needs refresh';
                    text.className = 'text-sm text-red-600';
                }
            }
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 max-w-sm transform transition-all duration-300 translate-x-full`;
            
            const colors = {
                success: 'bg-green-500 text-white',
                error: 'bg-red-500 text-white',
                info: 'bg-blue-500 text-white',
                warning: 'bg-yellow-500 text-black'
            };
            
            notification.className += ` ${colors[type] || colors.info}`;
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-xl opacity-70 hover:opacity-100">&times;</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                refreshAllData();
            }
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchMake').focus();
            }
        });

        // Initialize dashboard
        loadDashboardData();
        loadTopOpportunities();
    </script>
</body>
</html>