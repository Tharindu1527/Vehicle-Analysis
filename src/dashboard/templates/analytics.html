<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Vehicle Import Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.0/axios.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-gray-800">Vehicle Import Analyzer</h1>
                </div>
                <div class="flex space-x-8">
                    <a href="/" class="flex items-center px-3 py-2 text-gray-600 hover:text-gray-900">Dashboard</a>
                    <a href="/analytics" class="flex items-center px-3 py-2 text-blue-600 border-b-2 border-blue-600">Analytics</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Key Performance Indicators -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-600">Total Revenue Potential</h3>
                <p class="text-3xl font-bold text-green-600" id="totalRevenue">£0</p>
                <p class="text-sm text-gray-500 mt-2">Next 30 days</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-600">Average ROI</h3>
                <p class="text-3xl font-bold text-purple-600" id="avgROI">0%</p>
                <p class="text-sm text-gray-500 mt-2">All opportunities</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-600">Market Velocity</h3>
                <p class="text-3xl font-bold text-blue-600" id="marketVelocity">0</p>
                <p class="text-sm text-gray-500 mt-2">Days avg to sell</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-600">Risk Score</h3>
                <p class="text-3xl font-bold text-orange-600" id="avgRiskScore">0</p>
                <p class="text-sm text-gray-500 mt-2">Lower is better</p>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Profit Margin Distribution -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-4">Profit Margin Distribution</h3>
                <canvas id="profitMarginChart" width="400" height="200"></canvas>
            </div>

            <!-- Price Trends -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-4">Market Price Trends</h3>
                <canvas id="priceTrendChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Brand Performance -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Top Performing Brands -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-4">Top Performing Brands</h3>
                <canvas id="brandPerformanceChart" width="400" height="200"></canvas>
            </div>

            <!-- Opportunity Timeline -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-4">Opportunities by Month</h3>
                <canvas id="opportunityTimelineChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Detailed Analytics Tables -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Regional Performance -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-4">Regional Performance</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Region</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Avg Price</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Volume</th>
                                <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Velocity</th>
                            </tr>
                        </thead>
                        <tbody id="regionalPerformanceTable" class="divide-y divide-gray-200">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Risk Analysis -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold mb-4">Risk Analysis</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">High Risk Vehicles</span>
                        <span class="text-red-600 font-bold" id="highRiskCount">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Medium Risk Vehicles</span>
                        <span class="text-yellow-600 font-bold" id="mediumRiskCount">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Low Risk Vehicles</span>
                        <span class="text-green-600 font-bold" id="lowRiskCount">0</span>
                    </div>
                    <div class="mt-4">
                        <canvas id="riskDistributionChart" width="300" height="150"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load analytics data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadAnalyticsData();
            loadCharts();
        });

        async function loadAnalyticsData() {
            try {
                const response = await axios.get('/api/analytics-summary');
                if (response.data.success) {
                    const data = response.data.data;
                    
                    document.getElementById('totalRevenue').textContent = 
                        '£' + (data.total_revenue_potential || 0).toLocaleString();
                    document.getElementById('avgROI').textContent = 
                        (data.average_roi || 0).toFixed(1) + '%';
                    document.getElementById('marketVelocity').textContent = 
                        (data.average_days_to_sell || 0).toFixed(0);
                    document.getElementById('avgRiskScore').textContent = 
                        (data.average_risk_score || 0).toFixed(1);
                    
                    // Risk counts
                    document.getElementById('highRiskCount').textContent = data.high_risk_count || 0;
                    document.getElementById('mediumRiskCount').textContent = data.medium_risk_count || 0;
                    document.getElementById('lowRiskCount').textContent = data.low_risk_count || 0;
                }
            } catch (error) {
                console.error('Error loading analytics data:', error);
            }
        }

        async function loadCharts() {
            try {
                const response = await axios.get('/api/analytics-charts');
                if (response.data.success) {
                    const data = response.data.data;
                    
                    createProfitMarginChart(data.profit_margin_distribution);
                    createPriceTrendChart(data.price_trends);
                    createBrandPerformanceChart(data.brand_performance);
                    createOpportunityTimelineChart(data.opportunity_timeline);
                    createRiskDistributionChart(data.risk_distribution);
                }
            } catch (error) {
                console.error('Error loading chart data:', error);
            }
        }

        function createProfitMarginChart(data) {
            const ctx = document.getElementById('profitMarginChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0-10%', '10-20%', '20-30%', '30%+'],
                    datasets: [{
                        label: 'Number of Vehicles',
                        data: data || [0, 0, 0, 0],
                        backgroundColor: ['#ef4444', '#f59e0b', '#10b981', '#059669']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function createPriceTrendChart(data) {
            const ctx = document.getElementById('priceTrendChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data?.labels || [],
                    datasets: [{
                        label: 'Average Price',
                        data: data?.prices || [],
                        borderColor: '#3b82f6',
                        backgroundColor: '#3b82f630',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function createBrandPerformanceChart(data) {
            const ctx = document.getElementById('brandPerformanceChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data?.brands || [],
                    datasets: [{
                        data: data?.performance || [],
                        backgroundColor: [
                            '#ef4444', '#f59e0b', '#10b981', '#3b82f6', 
                            '#8b5cf6', '#f97316', '#06b6d4', '#84cc16'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }

        function createOpportunityTimelineChart(data) {
            const ctx = document.getElementById('opportunityTimelineChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data?.months || [],
                    datasets: [{
                        label: 'Opportunities',
                        data: data?.counts || [],
                        borderColor: '#8b5cf6',
                        backgroundColor: '#8b5cf630',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function createRiskDistributionChart(data) {
            const ctx = document.getElementById('riskDistributionChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Low Risk', 'Medium Risk', 'High Risk'],
                    datasets: [{
                        data: data || [0, 0, 0],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444']
                    }]
                },
                options: {
                    responsive: